{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-3 pb-5">

    <!-- En-t√™te Serveur -->
    <div class="d-flex justify-content-between align-items-center py-3 border-bottom mb-3">
        <div>
            <h5 class="fw-bold mb-0">Bonjour, {{ server_name }}! üëã</h5>
            <small class="text-muted">{{ today.strftime('%A %d %B %Y') }}</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
            {% if shift and not shift.actual_end_time %}
            <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size:0.5rem;"></i>En
                service</span>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger py-0">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </div>

    <!-- ALERTE T√ÇCHES EN RETARD -->
    {% if overdue_tasks %}
    <div class="alert alert-danger border-0 shadow-sm mb-3" style="border-radius:12px;">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
            <div>
                <strong>‚ö†Ô∏è {{ overdue_tasks|length }} t√¢che(s) en retard !</strong><br>
                <small>Veuillez les compl√©ter maintenant.</small>
            </div>
        </div>
        <ul class="mb-0 mt-2 small">
            {% for t in overdue_tasks %}
            <li><strong>{{ t.name }}</strong> ‚Äî pr√©vue √† {{ t.scheduled_time }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Boutons actions -->
    {% if not shift or shift.actual_end_time %}
    <div class="d-grid mb-3">
        <button class="btn btn-success py-3" style="border-radius:12px;font-size:1.1rem;" data-bs-toggle="modal"
            data-bs-target="#startShiftModal">
            <i class="bi bi-play-circle-fill me-2"></i>D√©marrer mon Service
        </button>
    </div>
    {% else %}
    <div class="d-grid mb-3">
        <button class="btn btn-danger py-3" style="border-radius:12px;font-size:1.1rem;" data-bs-toggle="modal"
            data-bs-target="#endShiftModal">
            <i class="bi bi-stop-circle-fill me-2"></i>Terminer mon Service
        </button>
    </div>
    {% endif %}

    <div class="row g-3">
        <!-- Checklist -->
        <div class="col-lg-8">
            {% for phase, tasks in tasks_by_phase.items() %}
            {% if tasks %}
            <div class="mb-3">
                <h6 class="fw-bold text-uppercase small text-muted mb-2">{{ phase }}</h6>
                <div class="card shadow-sm border-0" style="border-radius:12px;">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light small">
                                <tr>
                                    <th style="width:50px;" class="text-center">‚úì</th>
                                    <th>Description</th>
                                    <th class="text-center">Heure</th>
                                    <th class="text-center">Req.</th>
                                    <th class="text-center">Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in tasks %}
                                <tr id="task-{{ item.task.id }}"
                                    class="{% if item.status.is_done %}table-success opacity-75{% endif %}">
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input task-toggle"
                                            data-id="{{ item.task.id }}" {% if item.status.is_done %}checked{% endif %}
                                            style="width:1.3rem;height:1.3rem;cursor:pointer;">
                                    </td>
                                    <td>
                                        <span
                                            class="fw-medium {% if item.status.is_done %}text-decoration-line-through text-muted{% endif %}">
                                            {{ item.task.name }}
                                        </span>
                                    </td>
                                    <td class="text-center small font-monospace text-muted">{{ item.task.scheduled_time
                                        or '‚Äî' }}</td>
                                    <td class="text-center"><span class="badge bg-light text-dark border">{{
                                            item.task.required_people }}p</span></td>
                                    <td class="text-center" id="status-badge-{{ item.task.id }}">
                                        {% if item.status.is_done %}
                                        <span class="badge bg-success" style="font-size:0.6rem;">FAIT</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark" style="font-size:0.6rem;">√Ä
                                            FAIRE</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Sidebar Planning + Chat -->
        <div class="col-lg-4">
            <!-- Planning Semaine -->
            <div class="card p-3 mb-3 shadow-sm border-0" style="border-radius:16px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0"><i class="bi bi-calendar-check text-primary me-1"></i>Planning Semaine {{
                        current_week }}</h6>
                    <a href="{{ url_for('download_server_planning_pdf') }}" class="btn btn-sm btn-outline-primary py-0"
                        title="T√©l√©charger PDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </a>
                </div>
                {% set days = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'] %}
                {% for i in range(7) %}
                {% set p = weekly_plan[i] if i < weekly_plan|length else None %} <div
                    class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <span class="small fw-medium {% if i == today_idx %}text-primary fw-bold{% endif %}">{{ days[i]
                        }}</span>
                    {% if p %}
                    {% if p.is_off %}
                    <span class="badge bg-danger">OFF</span>
                    {% else %}
                    <span class="badge bg-success" style="font-size:0.65rem;">{{ p.start_time_str }}-{{ p.end_time_str
                        }}</span>
                    {% endif %}
                    {% else %}
                    <span class="text-muted small">‚Äî</span>
                    {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Messages -->
        <div class="card p-3 shadow-sm border-0" style="border-radius:16px;">
            <h6 class="fw-bold mb-2"><i class="bi bi-chat-dots text-primary me-1"></i>Messages</h6>
            <div id="chat-box" style="max-height:200px;overflow-y:auto;font-size:0.8rem;" class="mb-2">
                {% for msg in messages %}
                <div class="mb-1 {% if msg.server_id == 0 or msg.server_id == None %}text-end{% endif %}">
                    <span
                        class="d-inline-block px-2 py-1 rounded {% if msg.server_id == 0 or msg.server_id == None %}bg-primary text-white{% else %}bg-light text-dark border{% endif %}"
                        style="max-width:85%;">
                        {{ msg.content }}
                    </span>
                </div>
                {% endfor %}
            </div>
            <form method="POST" action="{{ url_for('send_message') }}" class="d-flex gap-1 mt-1">
                <input type="hidden" name="server_id" value="0">
                <input name="content" class="form-control form-control-sm" placeholder="Message..." required>
                <button class="btn btn-primary btn-sm"><i class="bi bi-send"></i></button>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Modal D√©marrer Service -->
<div class="modal fade" id="startShiftModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('start_shift') }}">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">D√©marrer Service</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Heure de prise de service pr√©vue: <strong>{{ expected_start_time_str
                            }}</strong></p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success btn-sm">Confirmer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Terminer Service -->
<div class="modal fade" id="endShiftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('end_shift') }}" enctype="multipart/form-data">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Terminer & Inventaire Stock</h5><button type="button"
                        class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Saisissez les donn√©es de stock avant de cl√¥turer votre service.</p>
                    {% if stock_items %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Produit</th>
                                    <th class="text-center">Quantit√© Initiale</th>
                                    <th class="text-center">Ventes</th>
                                    <th class="text-center">Stock R√©el</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stock_items %}
                                <tr>
                                    <td class="fw-medium small">{{ item.name }}</td>
                                    <td class="text-center"><input type="number" name="init_{{ item.id }}"
                                            class="form-control form-control-sm" value="{{ item.current_quantity }}"
                                            min="0" style="width:80px;margin:auto;"></td>
                                    <td class="text-center"><input type="number" name="sales_{{ item.id }}"
                                            class="form-control form-control-sm" value="0" min="0"
                                            style="width:80px;margin:auto;"></td>
                                    <td class="text-center"><input type="number" name="rem_{{ item.id }}"
                                            class="form-control form-control-sm" value="{{ item.current_quantity }}"
                                            min="0" style="width:80px;margin:auto;"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted fst-italic small">Aucun article en stock configur√©.</p>
                    {% endif %}
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger btn-sm">Terminer le service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.task-toggle').forEach(cb => {
        cb.addEventListener('change', function () {
            const id = this.dataset.id;
            fetch('/toggle_task/' + id, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const row = document.getElementById('task-' + id);
                        const badge = document.getElementById('status-badge-' + id);
                        if (this.checked) {
                            row.classList.add('table-success', 'opacity-75');
                            badge.innerHTML = '<span class="badge bg-success" style="font-size:0.6rem;">FAIT</span>';
                        } else {
                            row.classList.remove('table-success', 'opacity-75');
                            badge.innerHTML = '<span class="badge bg-warning text-dark" style="font-size:0.6rem;">√Ä FAIRE</span>';
                        }
                    }
                });
        });
    });
    // Scroll chat en bas
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}