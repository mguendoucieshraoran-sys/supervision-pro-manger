{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-3 pb-5">

    <!-- Navigation Sections -->
    <div class="d-flex gap-2 py-3 mb-3 border-bottom flex-wrap">
        <a href="?section=restauration"
            class="btn btn-sm {% if current_section == 'restauration' %}btn-dark{% else %}btn-outline-secondary{% endif %}">
            <i class="bi bi-cup-hot me-1"></i>Restauration
        </a>
        <a href="?section=hebergement"
            class="btn btn-sm {% if current_section == 'hebergement' %}btn-dark{% else %}btn-outline-secondary{% endif %}">
            <i class="bi bi-house me-1"></i>Hébergement
        </a>
        <div class="ms-auto d-flex gap-2 flex-wrap">
            <a href="{{ url_for('manage_tasks') }}" class="btn btn-sm btn-outline-primary"><i
                    class="bi bi-list-check me-1"></i>Tâches</a>
            <a href="{{ url_for('manage_servers') }}" class="btn btn-sm btn-outline-secondary"><i
                    class="bi bi-people me-1"></i>Équipe</a>
            <a href="{{ url_for('stock_manager') }}" class="btn btn-sm btn-outline-warning"><i
                    class="bi bi-box me-1"></i>Stock</a>
            <a href="{{ url_for('responsable_planning') }}" class="btn btn-sm btn-outline-success"><i
                    class="bi bi-calendar me-1"></i>Planning</a>
            <a href="{{ url_for('view_reports') }}" class="btn btn-sm btn-outline-danger"><i
                    class="bi bi-file-earmark-pdf me-1"></i>Rapports</a>
            <button class="btn btn-sm btn-info" onclick="generateReport()"><i class="bi bi-send me-1"></i>Rapport
                Hebdo</button>
        </div>
    </div>

    <!-- ALERTE TACHES EN RETARD -->
    {% if overdue_alerts %}
    <div class="alert alert-danger border-0 shadow-sm mb-3 p-0 overflow-hidden">
        <div class="d-flex align-items-center justify-content-between px-3 py-2" style="background:#dc3545;">
            <div class="d-flex align-items-center text-white">
                <i class="bi bi-bell-fill me-2 fs-5"></i>
                <span class="fw-bold">ALERTES : {{ overdue_alerts|length }} élément(s) nécessitent votre
                    attention</span>
            </div>
            <button class="btn btn-sm btn-light fw-bold py-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseAlerts">VOIR</button>
        </div>
        <div class="collapse bg-white" id="collapseAlerts">
            <div class="p-3">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-danger">
                        <tr>
                            <th>Serveur</th>
                            <th>Tâche / Élément</th>
                            <th>Heure Prévue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in overdue_alerts %}
                        <tr>
                            <td><span class="badge bg-danger">{{ a.srv }}</span></td>
                            <td>{{ a.task }}</td>
                            <td><span class="badge bg-warning text-dark">{{ a.time }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stats Rapides -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm text-center p-3" style="border-radius:12px;">
                <div class="fs-2 fw-bold text-success">{{ dashboard_data.task_completion_rate }}%</div>
                <div class="small text-muted">Tâches du jour</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm text-center p-3" style="border-radius:12px;">
                <div class="fs-2 fw-bold text-warning">{{ dashboard_data.low_stock_count }}</div>
                <div class="small text-muted">Alertes Stock</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm text-center p-3" style="border-radius:12px;">
                <div class="fs-2 fw-bold text-primary">{{ servers|length }}</div>
                <div class="small text-muted">Équipe active</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm text-center p-3" style="border-radius:12px;">
                <div class="fs-2 fw-bold text-info">{{ active_shifts|length }}</div>
                <div class="small text-muted">En service</div>
            </div>
        </div>
    </div>

    <!-- Tableau des Serveurs -->
    <div class="card border-0 shadow-sm" style="border-radius:12px;">
        <div class="card-header border-0 fw-bold py-2 px-3"
            style="background:#0f172a;color:white;border-radius:12px 12px 0 0;">
            <i class="bi bi-people-fill me-2"></i>Vue Équipe — {{ current_section|capitalize }}
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
                <thead class="table-light small">
                    <tr>
                        <th>Serveur</th>
                        <th class="text-center">Statut</th>
                        <th class="text-center">Tâches</th>
                        <th class="text-center">Heure Début</th>
                        <th class="text-center">Retard</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in servers %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ s.name }}</div>
                            <small class="text-muted">{{ s.department }}</small>
                        </td>
                        <td class="text-center">
                            {% set shift = active_shifts | selectattr('server_id', 'equalto', s.id) | first |
                            default(None) %}
                            {% if shift %}
                            <span class="badge bg-success"><i class="bi bi-circle-fill me-1"
                                    style="font-size:0.4rem;"></i>En service</span>
                            {% else %}
                            <span class="badge bg-secondary">Absent</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% set total = dashboard_data.task_stats.get(s.id, {}).get('total', 0) %}
                            {% set done = dashboard_data.task_stats.get(s.id, {}).get('done', 0) %}
                            {% if total > 0 %}
                            <span
                                class="badge {% if done == total %}bg-success{% elif done > 0 %}bg-warning text-dark{% else %}bg-danger{% endif %}">{{
                                done }}/{{ total }}</span>
                            {% else %}
                            <span class="text-muted small">—</span>
                            {% endif %}
                        </td>
                        <td class="text-center small">
                            {% if shift and shift.actual_start_time %}{{ shift.actual_start_time.strftime('%H:%M') }}{%
                            else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if shift and shift.lateness_minutes > 0 %}
                            <span class="badge bg-danger">+{{ shift.lateness_minutes }}min</span>
                            {% else %}
                            <span class="badge bg-success">OK</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{{ url_for('global_view') }}" class="btn btn-sm btn-outline-primary py-0">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4 fst-italic">Aucun serveur dans cette section.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Moniteur Stock Live -->
    {% if data and data.live_stock %}
    <div class="card border-0 shadow-sm mt-4" style="border-radius:12px;">
        <div class="card-header border-0 fw-bold py-2 px-3"
            style="background:#0f172a;color:white;border-radius:12px 12px 0 0;">
            <i class="bi bi-box-fill me-2"></i>Moniteur Stock Live
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
                <thead class="table-light small">
                    <tr>
                        <th>Produit</th>
                        <th class="text-center">Actuel</th>
                        <th class="text-center">Seuil Min</th>
                        <th class="text-center">Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.live_stock %}
                    <tr class="{% if item.status == 'alert' %}table-danger{% endif %}">
                        <td class="fw-medium small">{{ item.name }}</td>
                        <td class="text-center">{{ item.current }}</td>
                        <td class="text-center text-muted">{{ item.threshold }}</td>
                        <td class="text-center">
                            {% if item.status == 'alert' %}
                            <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>RÉAPPRO</span>
                            {% else %}
                            <span class="badge bg-success">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Messages -->
    <div class="card border-0 shadow-sm mt-4" style="border-radius:12px;">
        <div class="card-header border-0 fw-bold py-2 px-3"
            style="background:#0f172a;color:white;border-radius:12px 12px 0 0;">
            <i class="bi bi-chat-dots-fill me-2"></i>Messages d'équipe
        </div>
        <div class="card-body p-3">
            <div id="chat-box" style="max-height:200px;overflow-y:auto;font-size:0.82rem;" class="mb-2">
                {% for msg in messages %}
                <div class="mb-1 {% if msg.server_id == 0 or msg.server_id == None %}text-end{% endif %}">
                    <span
                        class="d-inline-block px-2 py-1 rounded {% if msg.server_id == 0 or msg.server_id == None %}bg-primary text-white{% else %}bg-light text-dark border{% endif %}"
                        style="max-width:80%;">
                        {% if msg.server_id and msg.server_id != 0 %}<small class="fw-bold d-block">{{
                            server_names.get(msg.server_id, 'Serveur') }}</small>{% endif %}
                        {{ msg.content }}
                    </span>
                </div>
                {% endfor %}
            </div>
            <form method="POST" action="{{ url_for('send_message') }}" class="d-flex gap-2">
                <select name="server_id" class="form-select form-select-sm" style="max-width:150px;">
                    <option value="all">→ Tous</option>
                    {% for srv in servers %}
                    <option value="{{ srv.id }}">→ {{ srv.name }}</option>
                    {% endfor %}
                </select>
                <input name="content" class="form-control form-control-sm" placeholder="Message..." required>
                <button class="btn btn-primary btn-sm"><i class="bi bi-send"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    function generateReport() {
        if (!confirm('Générer et envoyer le rapport hebdomadaire par mail ?')) return;
        fetch('/api/generate_weekly_report', { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) alert('Rapport généré ! PDF disponible dans Rapports.');
                else alert('Erreur: ' + (d.error || 'inconnue'));
            });
    }
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}