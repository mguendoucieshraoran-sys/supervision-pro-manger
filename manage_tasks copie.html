{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold"><i class="bi bi-list-check me-2 text-primary"></i>Gestion des Tâches</h4>
        <div class="d-flex gap-2">
            <a href="{{ url_for('manager_dashboard') }}" class="btn btn-outline-secondary btn-sm"><i
                    class="bi bi-arrow-left"></i> Retour</a>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="bi bi-plus-lg"></i> Nouvelle Tâche
            </button>
        </div>
    </div>

    {% for phase, task_list in tasks_by_phase.items() %}
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header fw-bold text-uppercase small py-2 px-3" style="background:#0f172a;color:white;">
            <i class="bi bi-clock me-2"></i>{{ phase }}
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
                <thead class="table-light small">
                    <tr>
                        <th>Nom de la Tâche</th>
                        <th class="text-center">Heure prévue</th>
                        <th class="text-center">Personnes req.</th>
                        <th class="text-center">Assigné à</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in task_list %}
                    <tr>
                        <td class="fw-medium">{{ t.name }}</td>
                        <td class="text-center"><span class="badge bg-light text-dark border">{{ t.scheduled_time or
                                '--:--' }}</span></td>
                        <td class="text-center">{{ t.required_people }}p</td>
                        <td class="text-center">
                            {% if t.assigned_server_id %}
                            {% for s in servers %}{% if s.id == t.assigned_server_id %}<span
                                class="badge bg-info text-dark">{{ s.name }}</span>{% endif %}{% endfor %}
                            {% else %}<span class="badge bg-secondary">Tous</span>{% endif %}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary py-0"
                                onclick="editTask({{ t.id }}, '{{ t.phase|replace("'", "\\'") }}', '{{ t.name|replace("'", "\\'") }}', '{{ t.scheduled_time }}', {{ t.required_people }}, {{ t.assigned_server_id or 'null' }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{ url_for('manage_tasks') }}" class="d-inline"
                                onsubmit="return confirm('Supprimer cette tâche ?')">
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="task_id" value="{{ t.id }}">
                                <button class="btn btn-sm btn-outline-danger py-0"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3 fst-italic small">Aucune tâche pour cette
                            phase.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Ajout/Édition -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('manage_tasks') }}">
                <input type="hidden" name="action" id="formAction" value="add">
                <input type="hidden" name="task_id" id="taskId">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Nouvelle Tâche</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Phase</label>
                        <select name="phase" id="taskPhase" class="form-select form-select-sm" required>
                            <option value="Avant le service">Avant le service</option>
                            <option value="Pendant le service">Pendant le service</option>
                            <option value="Après le service">Après le service</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nom de la tâche</label>
                        <input type="text" name="name" id="taskName" class="form-control form-control-sm" required
                            placeholder="Ex: Mise en place salle">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Heure prévue</label>
                            <input type="time" name="scheduled_time" id="taskTime" class="form-control form-control-sm">
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Personnes requises</label>
                            <input type="number" name="required_people" id="taskPeople"
                                class="form-control form-control-sm" value="1" min="1" max="20">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label small fw-bold">Assigner à <span
                                class="text-muted fw-normal">(facultatif)</span></label>
                        <select name="assigned_server_id" id="taskServer" class="form-select form-select-sm">
                            <option value="">— Tous les serveurs —</option>
                            {% for s in servers %}
                            <option value="{{ s.id }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editTask(id, phase, name, time, people, serverId) {
        document.getElementById('formAction').value = 'edit';
        document.getElementById('taskId').value = id;
        document.getElementById('taskPhase').value = phase;
        document.getElementById('taskName').value = name;
        document.getElementById('taskTime').value = time;
        document.getElementById('taskPeople').value = people;
        document.getElementById('taskServer').value = serverId || '';
        document.getElementById('modalTitle').textContent = 'Modifier la Tâche';
        document.getElementById('submitBtn').textContent = 'Enregistrer';
        new bootstrap.Modal(document.getElementById('addTaskModal')).show();
    }
</script>
{% endblock %}